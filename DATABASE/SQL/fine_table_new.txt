--1.7.5
/*
В таблице fine увеличить в два раза сумму неоплаченных штрафов для отобранных на предыдущем шаге записей. 
*/

UPDATE 
  fine, 
  (
    SELECT 
      name, 
      number_plate, 
      violation 
    FROM 
      fine 
    GROUP BY 
      name, 
      number_plate, 
      violation 
    HAVING 
      COUNT(violation) > 1 
    ORDER BY 
      name ASC, 
      number_plate ASC, 
      violation ASC
  ) AS query_in 
SET 
  fine.sum_fine = fine.sum_fine * 2 
WHERE 
  fine.name = query_in.name 
  AND fine.number_plate = query_in.number_plate 
  AND fine.date_payment IS Null;
SELECT 
  * 
FROM 
  fine;

--1.7.6
/*
Необходимо:
в таблицу fine занести дату оплаты соответствующего штрафа из таблицы payment; 
уменьшить начисленный штраф в таблице fine в два раза  (только для новых штрафов, дата оплаты которых занесена в payment),
если оплата произведена не более, чем за 20 дней со дня нарушения. 
*/

UPDATE 
  fine, 
  payment 
SET 
  fine.date_payment = IF(
    fine.date_payment IS Null, payment.date_payment, 
    fine.date_payment
  ), 
  fine.sum_fine = IF(
    DATEDIFF(
      payment.date_payment, payment.date_violation
    ) <= 20, 
    fine.sum_fine / 2, 
    fine.sum_fine
  ) 
WHERE 
  fine.name = payment.name 
  AND fine.number_plate = payment.number_plate 
  AND fine.violation = payment.violation 
  AND fine.date_violation = payment.date_violation;
SELECT 
  * 
FROM 
  fine;

 --1.7.7
/*
Необходимо:
Создать новую таблицу back_payment,
куда внести информацию о неоплаченных штрафах
(Фамилию и инициалы водителя, номер машины, нарушение, сумму штрафа  и  дату нарушения)
из таблицы fine.
*/

CREATE TABLE back_payment AS 
SELECT 
  name, 
  number_plate, 
  violation, 
  sum_fine, 
  date_violation 
FROM 
  fine 
WHERE 
  date_payment IS Null;
SELECT 
  * 
FROM 
  back_payment;

 --1.7.8
/*
Удалить из таблицы fine информацию о нарушениях,
совершенных раньше 1 февраля 2020 года. 
*/
DELETE FROM 
  fine 
WHERE 
  date_violation < '2020-02-01';
SELECT 
  * 
FROM 
  fine;

